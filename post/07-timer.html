<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>07-timer | Chilh</title><meta name="author" content="chilh"><meta name="copyright" content="chilh"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="微处理器笔记 07-timer">
<meta property="og:type" content="article">
<meta property="og:title" content="07-timer">
<meta property="og:url" content="https://chilh.top/post/07-timer.html">
<meta property="og:site_name" content="Chilh">
<meta property="og:description" content="微处理器笔记 07-timer">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202306161931372.webp">
<meta property="article:published_time" content="2023-06-16T10:00:35.000Z">
<meta property="article:modified_time" content="2023-07-21T06:15:35.935Z">
<meta property="article:author" content="chilh">
<meta property="article:tag" content="大三下课程笔记">
<meta property="article:tag" content="BUPT">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202306161931372.webp"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://chilh.top/post/07-timer.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: chilh","link":"链接: ","source":"来源: Chilh","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '07-timer',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-07-21 14:15:35'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script><script>LA.init({id:"Jz34H84gllFAWP2o",ck:"Jz34H84gllFAWP2o"})</script><script src="https://sdk.51.la/perf/js-sdk-perf.min.js" crossorigin="anonymous"></script><script> new LingQue.Monitor().init({id:"Jz365mPYN13QqIwT"});</script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/map/js/china.js"></script><script src="https://npm.elemecdn.com/echarts@4.9.0/dist/echarts.min.js"></script><meta name="generator" content="Hexo 6.1.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/%E5%A4%B4%E5%83%8F.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-camera-retro"></i><span> 图库</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fa fa-heartbeat"></i><span> 统计</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202306161931372.webp')"><nav id="nav"><span id="blog-info"><a href="/" title="Chilh"><span class="site-name">Chilh</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-camera-retro"></i><span> 图库</span></a></div><div class="menus_item"><a class="site-page" href="/charts/"><i class="fa-fw fa fa-heartbeat"></i><span> 统计</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">07-timer</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-06-16T10:00:35.000Z" title="发表于 2023-06-16 18:00:35">2023-06-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-07-21T06:15:35.935Z" title="更新于 2023-07-21 14:15:35">2023-07-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%A7%E5%AD%A6%E7%AC%94%E8%AE%B0/">大学笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>12分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="07-timer"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Timer-Peripherals"><a href="#Timer-Peripherals" class="headerlink" title="Timer Peripherals"></a>Timer Peripherals</h1><h2 id="How-long-does-it-take-to-execute-an-ARM-instruction"><a href="#How-long-does-it-take-to-execute-an-ARM-instruction" class="headerlink" title="How long does it take to execute an ARM instruction?"></a>How long does it take to execute an ARM instruction?</h2><p>Different instructions requires different clock cycles to complete.</p>
<p>• CPI = Clock Per Instruction 每条指令所需时钟周期数</p>
<p>• For instance, CPI of MOV is 1 (unless move to PC).</p>
<p>ARM M3/M4是pipelined processor，因此可以并行执行多个指令以节省时间。因此，CPI并不固定（但是平均值是可计算的）</p>
<p>The actual timing of instructions can only be determined when the whole program is ready for simulation or analysis.</p>
<p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305080818477.png" alt="image-20230508081853396"></p>
<h3 id="Time-Delay-Loop"><a href="#Time-Delay-Loop" class="headerlink" title="Time Delay Loop"></a>Time Delay Loop</h3><p>Estimate the time taken to execute the following code snippet (in terms of clock cycles):</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">DELAY
	MOV r0, #250
LOOP
	SUBS r0, #1
	BNE LOOP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>MOV指令需要1个时钟周期，SUBS指令需要1个时钟周期，BNE指令需要3个时钟周期</p>
<p>Time delay<br>~= 1 + 250 x (1 + 3)<br>~= 1001 cycles<br>This is approximate because of BNE.</p>
<hr>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">DELAY
	MOV r0, #250
LOOP
	NOP
	NOP
	NOP
	NOP
	SUBS r0, #1
	BNE LOOP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>NOP需要一个周期</p>
<p>Time delay<br>~= 1 + 250 x (1 x 4 + 1 + 3)<br>~= 2001 cycles<br>if CPU runs at 80 MHz, this takes approximate 25 μs to execute.</p>
<p>2001/80,000,000秒，约为25微秒（μs）</p>
<h3 id="Longer-Time-Delay"><a href="#Longer-Time-Delay" class="headerlink" title="Longer Time Delay"></a>Longer Time Delay</h3><p>可以实现精确的时间延迟</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">__asm void delay_cycles(unsigned int cycles){
LSRS r0, #2 // logic shift right 2 bits (/4)
BEQ done
loop // each time it takes 4 cycles
SUBS r0, #1
BNE loop
done
BX lr
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Time delay = 1 + 1 + cycles/4 x (1 + 3) + 2 (assume BEQ not taken)= cycles + 4</p>
<p>一开始除4是因为后面循环里有四个周期的指令所以保证传入的参数为cycle</p>
<p>？？？？？</p>
<h4 id="实现一个任意长度的延时"><a href="#实现一个任意长度的延时" class="headerlink" title="实现一个任意长度的延时"></a>实现一个任意长度的延时</h4><p>The no. of cycles that can be waited is limited by the size of unsigned int = 32 bits in ARM M3/M4, so we need to calculate how many times we need to call <strong>delay_cycles()</strong>, depending on the clock frequency (<strong>SystemCoreClock</strong> in the code)</p>
<p> SystemCoreClock:频率，一秒中有几个周期</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">void delay_ms(unsigned int ms) {
unsigned int max_step =               //最多计时多少ms 
1000 * (UINT32_MAX / SystemCoreClock);//乘以1000是为了将延迟时间从秒转换为毫秒
unsigned int max_sleep_cycles = 
max_step * (SystemCoreClock / 1000); //最多记多少个时钟周期数
while (ms &gt; max_step) {
ms -= max_step;
delay_cycles(max_sleep_cycles);
}
delay_cycles(ms * (SystemCoreClock / 1000));
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>SystemCoreClock是一个变量，它存储了当前系统的时钟频率</p>
<p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305081704495.png" alt="image-20230508170404428"></p>
<h2 id="Timer-Concept"><a href="#Timer-Concept" class="headerlink" title="Timer: Concept"></a>Timer: Concept</h2><p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305081711944.png" alt="image-20220430165555035"></p>
<ul>
<li><p>Based on <strong>presettable</strong> (i.e. load with a start value) binary counter</p>
</li>
<li><p>It is enhanced with configurability:</p>
<ul>
<li><p>Count value can be read and written by the processor 可自定义计数</p>
</li>
<li><p>Count direction can often <strong>be set to up or down</strong> 可向上或者向下计数</p>
</li>
<li><p>Counter’s <strong>clock source can be selected</strong></p>
<ul>
<li>Counter mode: count pulses which indicate events (e.g. odometer pulses)</li>
<li>Timer mode: clock source is periodic, so counter value is proportional to elapsed time (e.g. stopwatch)</li>
</ul>
</li>
<li><p><strong>Counter’s overflow/underflow action can be selected</strong></p>
<p>Generate interrupt</p>
<p>Reload counter with special value and continue counting<br>Toggle hardware output signal</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305081727616.png" alt="image-20230508172715566"></p>
<h3 id="Interrupt-Timer"><a href="#Interrupt-Timer" class="headerlink" title="Interrupt Timer"></a>Interrupt Timer</h3><p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305081727778.png" alt="image-20230508172729744"></p>
<p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305081728179.png" alt="image-20230508172800148"></p>
<p>• Load start value from register</p>
<p>• Counter counts down with each clock pulse</p>
<p>• When timer value reaches zero</p>
<p>​	• Generates interrupt</p>
<p>​	• <strong>Reloads</strong> timer with start value</p>
<h4 id="Calculating-Start-Value"><a href="#Calculating-Start-Value" class="headerlink" title="Calculating Start Value"></a>Calculating Start Value</h4><p>计算初始值</p>
<p>Start value = round(<em>T</em> x Freq) - 1</p>
<p>T是所需的中断间隔（以秒为单位），Freq是时钟频率（以赫兹为单位）。由于定时器的计数器寄存器只能容纳整数值，因此此公式的结果应四舍五入到最近的整数。</p>
<p>• Example 1: interrupt every 137.41 ms, assuming clock frequency 24 MHz</p>
<p>​	• 137.41 ms x 24 MHz – 1 = 3297839 (happens to be integer)</p>
<p>• Example 2: interrupt with a frequency of 88 Hz with a 56 MHz clock</p>
<p>​	• round((1/88 Hz) x 46 MHz) - 1 = 522726</p>
<p>​	• actual frequency = 88.0000004591 Hz (very small error)</p>
<p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305081734294.png" alt="image-20230508173459249"></p>
<p>以100微秒的分辨率测量时间并显示经过的时间，每10毫秒更新屏幕。它使用中断定时器和一个计数器，每100微秒从起始值递减。定时器设置为每100微秒到期一次，并使用公式round(T x Freq) - 1计算起始值，其中T是所需的时间间隔，Freq是时钟频率。例如，在24 MHz的时钟频率下，100微秒时间间隔的起始值将为round(100微秒 x 24 MHz) - 1 = 2399。LCD在N-th ISR更新一次，其中N等于10毫秒/100微秒 = 100。为避免减慢ISR速度，在ISR中设置标志并在主循环中轮询该标志来更新LCD。</p>
<h3 id="PWM-Module-TPM"><a href="#PWM-Module-TPM" class="headerlink" title="PWM Module (TPM)"></a>PWM Module (TPM)</h3><p><strong>Core Counter</strong></p>
<ul>
<li>Clock options - external or internal (signal)</li>
<li>Prescaler to divide clock (预分频分)</li>
<li>Can reload with set value, or overflow and wrap around</li>
</ul>
<p>Multiple channels - <strong>several modes</strong></p>
<ul>
<li><p>Capture Mode: <strong>Capture timer’s value when input signal changes</strong></p>
</li>
<li><p>Output Compare: <strong>Change an output signal when timer reaches certain value</strong>.</p>
<p>输出比较模式。在输出比较模式下，当计时器达到指定值时，可以修改输出信号。可以设置、清除、脉冲或切换（反转）输出信号</p>
</li>
<li><p>PWM: <strong>Generate pulse-width-modulated signal. Width of pulse is proportional to specified value.</strong></p>
</li>
</ul>
<p><strong>Possible triggering of interrupt, hardware trigger on overflow</strong></p>
<p><strong>One I/O pin per channel</strong></p>
<h4 id="Major-Channel-Modes"><a href="#Major-Channel-Modes" class="headerlink" title="Major Channel Modes"></a>Major Channel Modes</h4><ul>
<li>Input Capture Mode</li>
</ul>
<p>捕获模式。在捕获模式下，计时器会在输入信号发生变化（上升沿、下降沿或两者）时捕获计时器的值。这种模式可以回答一个问题：“我启动计时器后多久输入信号发生变化？”因此，它有效地测量时间差异。</p>
<ul>
<li><p>Output Compare Mode</p>
<p>Modify output signal when timer reaches specified value Set, clear, pulse, toggle (invert)</p>
<p>Make a pulse of specified width</p>
<p>Make a pulse after specified delay</p>
</li>
</ul>
<p>Output Compare Mode 是一种计时器模式，用于比较计时器的值和预设的比较值。当计时器的值与比较值相等时，可以执行一些操作，例如生成输出信号或调用中断。在Output Compare Mode中，可以设置不同的操作类型，例如Toggle、Clear和Set等。</p>
<ul>
<li>Pulse Width Modulation</li>
</ul>
<p>Make a series of pulses of specified width and frequency</p>
<h5 id="Input-Capture-Mode"><a href="#Input-Capture-Mode" class="headerlink" title="Input Capture Mode"></a>Input Capture Mode</h5><p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305081748134.png" alt="image-20230508174854095"></p>
<p>I/O pin operates as input on edge</p>
<p>• When valid edge is detected on pin…</p>
<p>​		• Current value of counter is stored</p>
<p>​		• Interrupt is called</p>
<p>当有效边沿到来时，启动中断，并保存当前值</p>
<p>当计时器捕获到输入信号的状态变化时，会触发一个中断，并将当前计数器的值保存下来。</p>
<h4 id="Output-Compare-Mode"><a href="#Output-Compare-Mode" class="headerlink" title="Output Compare Mode"></a>Output Compare Mode</h4><p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305082006430.png" alt="image-20230508200606387"></p>
<p>设置比较值来控制输出信号的变化方式，如切换、清除或设置等。</p>
<p>Action on match</p>
<p>• Toggle</p>
<p>• Clear</p>
<p>• Set</p>
<p>When counter matches value …</p>
<p>• Output signal is generated</p>
<p>• Interrupt is called (if enabled)</p>
<h4 id="Pulse-Width-Modulation-PWM"><a href="#Pulse-Width-Modulation-PWM" class="headerlink" title="Pulse Width Modulation (PWM)"></a>Pulse Width Modulation (PWM)</h4><p>• Digital power amplifiers are more efficient and less expensive than analog power amplifiers</p>
<p>• Applications: motor speed control, light dimmer, switch-mode power conversion</p>
<p>• Load (motor, light, etc.) responds slowly, averages PWM signal</p>
<p>• Digital communication is less sensitive to noise than analog methods</p>
<p>​		• PWM provides a digital encoding of an analog value</p>
<p>​		• Much less vulnerable to noise</p>
<h5 id="PWM-signal-characteristics"><a href="#PWM-signal-characteristics" class="headerlink" title="PWM signal characteristics"></a>PWM signal characteristics</h5><p>• Fixed modulation frequency <em>fmod</em> how many pulses occur per second </p>
<p>固定的调制频率fmod，即每秒发生多少个脉冲</p>
<p>• Period: 1 / <em>fmod</em></p>
<p>• On-time: amount of time that each pulse is on (asserted)</p>
<p>• Duty-cycle: on-time/period</p>
<p>• Adjust on-time (hence duty cycle) to represent the analog value</p>
<p>占空比为高电平时间与周期时间之比，可以通过调整高电平时间来改变占空比，从而实现对外设的控制。</p>
<p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305082021362.png" alt="image-20230508202130315"></p>
<p>PWM duty cycle proportional to compare value 占空比和比较值成正比</p>
<p><strong>• Period = max timer value(最多能记多少数)</strong></p>
<p><strong>• On-time = compare value（设定的比较值）</strong></p>
<p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305082022855.png" alt="image-20230508202211820"></p>
<h5 id="Servo-Motor"><a href="#Servo-Motor" class="headerlink" title="Servo Motor"></a>Servo Motor</h5><p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305082024817.png" alt="image-20230508202407753"></p>
<p>在PWM模式下，可以通过改变比较值来控制输出信号的高电平时间，从而控制伺服电机的转动角度。具体地说，PWM信号的周期为20ms，高电平时间在1ms到2ms之间变化，对应着伺服电机转动角度在0度到180度之间变化。</p>
<h3 id="Low-Power-Timer"><a href="#Low-Power-Timer" class="headerlink" title="Low Power Timer"></a>Low Power Timer</h3><p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305082026343.png" alt="image-20230508202609300"></p>
<p>•特点</p>
<p>•计数时间或外部脉冲 当计数器匹配比较值时产生中断</p>
<p>•中断从低功耗模式唤醒MCU</p>
<p>•电流绘制可以降低到微安甚至纳安!</p>
<p>Use the <strong>WFI</strong> (Wait For Instruction) instruction (<strong>__WFI()</strong> in C)</p>
<p>• Puts CPU in low power mode until interrupt request</p>
<h2 id="Programming-SysTick-and-Interrupt-in-C-with-CMSIS"><a href="#Programming-SysTick-and-Interrupt-in-C-with-CMSIS" class="headerlink" title="Programming SysTick and Interrupt in C (with CMSIS)"></a>Programming SysTick and Interrupt in C (with CMSIS)</h2><p>Cortex-M processors have a small <strong>integrated timer called the SysTick (System Tick) timer.</strong> Cortex‐M3 处理器内部包含了一个简单的定时器。因为所有的 CM3 芯片都带有这个定时器，软件在不同 CM3 器件间的移植工作得以化简。</p>
<ul>
<li>Part of NVIC, generating SysTick interrupt.</li>
</ul>
<p>SysTick timer is a simple ==decrement== ==24-bit== timer.</p>
<ul>
<li>either <strong>on processor clock frequency</strong> 处理器时钟频率, or</li>
<li><strong>a reference clock frequency</strong> (e.g. on-chip clock source 片上时钟源)</li>
</ul>
<p> Systick 是 <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=STM32&amp;spm=1001.2101.3001.7020">STM32</a> 的一个系统定时器，又名系统嘀嗒定时器，是一个 24 位的倒计数定时器，当计数到 0 时，将从 RELOAD 寄存器中自动重装载定时初值，开始新一轮计数。</p>
<p>It is common in modern OS that we need a periodic interrupt to execute the OS kernel.</p>
<p>Even without an OS, SysTick can be used for periodic interrupt generation, delay generation, or timing measurement.</p>
<p>即使没有操作系统，SysTick也可以用于周期性中断生成、延迟生成或时间测量。</p>
<h4 id="SysTick-timer-has-4-registers"><a href="#SysTick-timer-has-4-registers" class="headerlink" title="SysTick timer has 4 registers."></a>SysTick timer has 4 registers.</h4><p>• The data structure SysTick is defined in CMSIS to access them easily.</p>
<p>SysTick定时器在CTRL寄存器的第0位启用。当SysTick计数器减为0时，它将从VAL寄存器中加载一个新值，并继续计数。</p>
<p>VAL寄存器是SysTick定时器的当前值寄存器，它保存了当前的计数值。</p>
<p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305082104890.png" alt="image-20230508210428845"></p>
<p>控制及状态寄存器（CTRL）</p>
<p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305082105964.png" alt="image-20230508210552866"></p>
<p>重装载数值寄存器（LOAD）</p>
<p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305082106048.png" alt="image-20230508210600986"></p>
<p>几个周期</p>
<p>当前数字寄存器（VAL）</p>
<p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305082106826.png" alt="image-20230508210608755"></p>
<p>校准数值寄存器（CALIB）</p>
<p><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202305082106904.png" alt="image-20230508210615856"></p>
<h3 id="Using-the-SysTick-Timer-CMSIS"><a href="#Using-the-SysTick-Timer-CMSIS" class="headerlink" title="Using the SysTick Timer (CMSIS)"></a>Using the SysTick Timer (CMSIS)</h3><p>The easiest way to generate a period SysTick interrupt is to use this CMSIS-Core fuction:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint32_t</span> <span class="token function">SysTick_Config</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> ticks<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>The function sets the interrupt interval to ticks, enables the counter using processor clock and enables the SysTick exception with lowest priority.</p>
<p>将中断周期设置为ticks，并使用处理器时钟启用计数器和SysTick异常，优先级最低。</p>
<p>优先级最低，因此其他中断可以在SysTick异常之前被处理。</p>
<p>Example: if you want to trigger a SysTick exception of 1 kHz,</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">SysTick_config</span><span class="token punctuation">(</span>SystemCoreClock <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>SystemCoreClock:系统周期，对应频率1HZ，除1000，对应频率1000Hz</p>
<p>Then <strong>SysTick_Handler(void)</strong> is triggered at a rate of 1 kHz</p>
<h4 id="Writing-to-SysTick-registers"><a href="#Writing-to-SysTick-registers" class="headerlink" title="Writing to SysTick registers"></a>Writing to SysTick registers</h4><p>如果你想使用参考时钟源或不触发中断，你可以直接写到SysTick寄存器。</p>
<ol>
<li><p>在“SysTick-&gt;CTRL”中输入“0”，关闭SysTick定时器。(以防之前已启用)</p>
</li>
<li><p>将新的加载值写入 SysTick-&gt;LOAD  重新加载值应该是(间隔值- 1)。</p>
</li>
<li><p>写入SysTick当前值寄存器 SysTick-&gt;VAL    清除当前值为0。</p>
</li>
<li><p>写入到SysTick控制和状态寄存器 SysTick-&gt;CTRL   启动SysTick定时器</p>
</li>
</ol>
<p>A simple C example of polling SysTick value for timed delay.</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 		<span class="token comment">// stop SysTick</span>
SysTick<span class="token operator">-&gt;</span>LOAD <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span> 	<span class="token comment">// count 255+1=256 cycles</span>
SysTick<span class="token operator">-&gt;</span>VAL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">//使能+内核时钟</span>

<span class="token comment">// wait until count flag is set</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">&amp;</span> <span class="token number">0x00010000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//16bits变为1</span>
SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 	<span class="token comment">// stop SysTick</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Building-Driver-for-SysTicks"><a href="#Building-Driver-for-SysTicks" class="headerlink" title="Building Driver for SysTicks"></a>Building Driver for SysTicks</h3><ul>
<li>设置每(timestamp)μs触发一个interrupt</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">timer_init</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>设置Interrupt handler</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">timer_set_callback</span><span class="token punctuation">(</span>timer_isr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>启动SysTicks</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">timer_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>关闭SysTicks</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">timer_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="timer-init"><a href="#timer-init" class="headerlink" title="timer_init()"></a>timer_init()</h4><h4 id=""><a href="#" class="headerlink" title=""></a></h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">timer_init</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">uint32_t</span> tick_us <span class="token operator">=</span> <span class="token punctuation">(</span>SystemCoreClock<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1e6</span><span class="token punctuation">;</span>
	tick_us <span class="token operator">=</span> tick_us<span class="token operator">*</span>timestamp<span class="token punctuation">;</span>
	<span class="token function">SysTick_Config</span><span class="token punctuation">(</span>tick_us<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//NVIC_SetPriority(SysTick_IRQn, 3);</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Explanation:</p>
<ul>
<li>Calculate how many cycles for <strong>each millisecond</strong></li>
<li>Multiply with timestamp to get required interval (in cycles)</li>
<li>Configure the interval using SysTick_Config()</li>
<li><em>Change interrupt priority if needed</em></li>
</ul>
<h4 id="Enable-x2F-Disable-Timer"><a href="#Enable-x2F-Disable-Timer" class="headerlink" title="Enable/Disable Timer"></a>Enable/Disable Timer</h4><p>Start and stop the timer by setting/clearing the right bits</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">timer_enable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">=</span> SysTick_CTRL_CLKSOURCE_Msk <span class="token operator">|</span>
				SysTick_CTRL_TICKINT_Msk <span class="token operator">|</span>
				SysTick_CTRL_ENABLE_Msk<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
将三个bit初始化
<span class="token keyword">void</span> <span class="token function">timer_disable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">&amp;=</span> <span class="token operator">~</span>SysTick_CTRL_ENABLE_Msk<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
只将enable设为<span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>• start: processor clock, enable interrupt and enable timer</p>
<p>• stop: disable timer (clear bit 0)</p>
<p>• All bit masks (e.g. SysTick_CTRL_CLKSOURCE_Msk) are defined for compatibility (and no need to remember exact bit no.)</p>
<p>Set up a pointer to function for the interrupt service routine</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>timer_callback<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">timer_set_callback</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>callback<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
timer_callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">SysTick_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token function">timer_callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>用户通过调用timer_set_callback()提供一个指向回调函数(实际的ISR)的指针。让timer_callback指向ISR</p>
<p>当计时器中断发生时，SysTick_Handler()被调用，然后它访问回调的指针并调用函数。</p>
<h4 id="使用实例-Flashing-an-LED"><a href="#使用实例-Flashing-an-LED" class="headerlink" title="使用实例 Flashing an LED"></a>使用实例 Flashing an LED</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">toggle_led</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">gpio_toggle</span><span class="token punctuation">(</span>LED_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">timer_init</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 100 ms = 100000 us</span>
	<span class="token function">timer_set_callback</span><span class="token punctuation">(</span>toggle_led<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">timer_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__enable_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token function">__WFI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>__enable_irq()</code>: The function enables interrupts and all configurable fault handlers by clearing PRIMASK.</li>
<li><code>__WFI()</code> suspends execution until one of the following events occurs (put in low power mode). But the while loop can be replaced by other tasks to be run in parallel.</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://chilh.top">chilh</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://chilh.top/post/07-timer.html">https://chilh.top/post/07-timer.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://chilh.top" target="_blank">Chilh</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%A4%A7%E4%B8%89%E4%B8%8B%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/">大三下课程笔记</a><a class="post-meta__tags" href="/tags/BUPT/">BUPT</a></div><div class="post_share"><div class="social-share" data-image="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202306161931372.webp" data-sites="twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E5%AF%BC%E8%AE%BA%20%E7%AC%AC%E4%BA%8C%E7%AB%A0%20%E6%8E%A8%E7%90%86.html" title="人工智能导论 第二章 推理"><img class="cover" src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202306161954208.jfif" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">人工智能导论 第二章 推理</div></div></a></div><div class="next-post pull-right"><a href="/post/08-I2C.html" title="08-I2C"><img class="cover" src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202306161931372.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">08-I2C</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/01%20Introduction.html" title="互联网应用笔记（一）"><img class="cover" src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202306221734670.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-20</div><div class="title">互联网应用笔记（一）</div></div></a></div><div><a href="/post/01-introduction.html" title="01- introduction"><img class="cover" src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202306161931372.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-16</div><div class="title">01- introduction</div></div></a></div><div><a href="/post/02.5%20linux.html" title="互联网应用笔记（三）"><img class="cover" src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202306221734670.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-20</div><div class="title">互联网应用笔记（三）</div></div></a></div><div><a href="/post/02%20stocker%20programming.html" title="互联网应用笔记（二）"><img class="cover" src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202306221734670.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-20</div><div class="title">互联网应用笔记（二）</div></div></a></div><div><a href="/post/02-ARM%20Cortex-M4.html" title="02-ARM Cortex-M4"><img class="cover" src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202306161931372.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-16</div><div class="title">02-ARM Cortex-M4</div></div></a></div><div><a href="/post/03-C%20as%20Implemented%20in%20Assembly%20Language.html" title="03-C as Implemented in Assembly Language"><img class="cover" src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202306161931372.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-06-16</div><div class="title">03-C as Implemented in Assembly Language</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/%E5%A4%B4%E5%83%8F.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">chilh</div><div class="author-info__description">记录学习笔记，学艺不精，大家多多评论指教</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:1547405085@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Timer-Peripherals"><span class="toc-number">1.</span> <span class="toc-text">Timer Peripherals</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#How-long-does-it-take-to-execute-an-ARM-instruction"><span class="toc-number">1.1.</span> <span class="toc-text">How long does it take to execute an ARM instruction?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Time-Delay-Loop"><span class="toc-number">1.1.1.</span> <span class="toc-text">Time Delay Loop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Longer-Time-Delay"><span class="toc-number">1.1.2.</span> <span class="toc-text">Longer Time Delay</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E4%BB%BB%E6%84%8F%E9%95%BF%E5%BA%A6%E7%9A%84%E5%BB%B6%E6%97%B6"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">实现一个任意长度的延时</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Timer-Concept"><span class="toc-number">1.2.</span> <span class="toc-text">Timer: Concept</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Interrupt-Timer"><span class="toc-number">1.2.1.</span> <span class="toc-text">Interrupt Timer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Calculating-Start-Value"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">Calculating Start Value</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PWM-Module-TPM"><span class="toc-number">1.2.2.</span> <span class="toc-text">PWM Module (TPM)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Major-Channel-Modes"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">Major Channel Modes</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Input-Capture-Mode"><span class="toc-number">1.2.2.1.1.</span> <span class="toc-text">Input Capture Mode</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Output-Compare-Mode"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">Output Compare Mode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pulse-Width-Modulation-PWM"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">Pulse Width Modulation (PWM)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#PWM-signal-characteristics"><span class="toc-number">1.2.2.3.1.</span> <span class="toc-text">PWM signal characteristics</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Servo-Motor"><span class="toc-number">1.2.2.3.2.</span> <span class="toc-text">Servo Motor</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-Power-Timer"><span class="toc-number">1.2.3.</span> <span class="toc-text">Low Power Timer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Programming-SysTick-and-Interrupt-in-C-with-CMSIS"><span class="toc-number">1.3.</span> <span class="toc-text">Programming SysTick and Interrupt in C (with CMSIS)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SysTick-timer-has-4-registers"><span class="toc-number">1.3.0.1.</span> <span class="toc-text">SysTick timer has 4 registers.</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-the-SysTick-Timer-CMSIS"><span class="toc-number">1.3.1.</span> <span class="toc-text">Using the SysTick Timer (CMSIS)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Writing-to-SysTick-registers"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">Writing to SysTick registers</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Building-Driver-for-SysTicks"><span class="toc-number">1.3.2.</span> <span class="toc-text">Building Driver for SysTicks</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#timer-init"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">timer_init()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-number">1.3.2.2.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Enable-x2F-Disable-Timer"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">Enable&#x2F;Disable Timer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B-Flashing-an-LED"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">使用实例 Flashing an LED</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/2024-lastday.html" title="无题"><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202501010045372.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/post/2024-lastday.html" title="无题">无题</a><time datetime="2024-12-31T14:59:00.000Z" title="发表于 2024-12-31 22:59:00">2024-12-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/riscv%20v%E6%89%A9%E5%B1%95%E7%BF%BB%E8%AF%91%E6%80%BB%E7%BB%93.html" title="v扩展翻译总结”"><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202411102035591.jfif" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="v扩展翻译总结”"/></a><div class="content"><a class="title" href="/post/riscv%20v%E6%89%A9%E5%B1%95%E7%BF%BB%E8%AF%91%E6%80%BB%E7%BB%93.html" title="v扩展翻译总结”">v扩展翻译总结”</a><time datetime="2024-11-10T12:30:33.000Z" title="发表于 2024-11-10 20:30:33">2024-11-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/2023%E6%9C%80%E5%90%8E%E4%B8%80%E5%A4%A9%E7%9A%84%E7%95%99%E8%A8%80.html" title="2023最后一天的留言"><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202312312339644.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2023最后一天的留言"/></a><div class="content"><a class="title" href="/post/2023%E6%9C%80%E5%90%8E%E4%B8%80%E5%A4%A9%E7%9A%84%E7%95%99%E8%A8%80.html" title="2023最后一天的留言">2023最后一天的留言</a><time datetime="2023-12-31T14:59:00.000Z" title="发表于 2023-12-31 22:59:00">2023-12-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/ysyx%E9%A2%84%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-pa1.html" title="ysyx预学习记录--pa1"><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202308101531521.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ysyx预学习记录--pa1"/></a><div class="content"><a class="title" href="/post/ysyx%E9%A2%84%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-pa1.html" title="ysyx预学习记录--pa1">ysyx预学习记录--pa1</a><time datetime="2023-08-10T07:27:15.000Z" title="发表于 2023-08-10 15:27:15">2023-08-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/DFT-S-OFDM.html" title="DFT-S-OFDM"><img src="https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202307211649897.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DFT-S-OFDM"/></a><div class="content"><a class="title" href="/post/DFT-S-OFDM.html" title="DFT-S-OFDM">DFT-S-OFDM</a><time datetime="2023-07-21T08:45:03.000Z" title="发表于 2023-07-21 16:45:03">2023-07-21</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://chilh-1311344212.cos.ap-beijing.myqcloud.com/picture/202306161931372.webp')"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2025 By chilh</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadWaline () {
  function insertCSS () {
    const link = document.createElement("link")
    link.rel = "stylesheet"
    link.href = "https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.css"
    document.head.appendChild(link)
  }

  function initWaline () {
    const waline = Waline.init(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://chilh-comment-nwkfkyqk8-zhanzghouhe.vercel.app',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: false,
    }, null))
  }

  if (typeof Waline === 'function') initWaline()
  else {
    insertCSS()
    getScript('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.js').then(initWaline)
  }
}

if ('Waline' === 'Waline' || !true) {
  if (true) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
  else setTimeout(loadWaline, 0)
} else {
  function loadOtherComment () {
    loadWaline()
  }
}</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":85,"height":400,"hOffset":-18,"vOffset":25},"mobile":{"show":true},"react":{"opacity":0.7},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>